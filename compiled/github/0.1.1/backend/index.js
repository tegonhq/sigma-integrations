"use strict";var t=require("axios"),e=function(){return e=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},e.apply(this,arguments)};function n(t,e,n,r){return new(n||(n=Promise))((function(a,c){function o(t){try{i(r.next(t))}catch(t){c(t)}}function s(t){try{i(r.throw(t))}catch(t){c(t)}}function i(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,s)}i((r=r.apply(t,e||[])).next())}))}function r(t,e){var n,r,a,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(i){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(c=0)),c;)try{if(n=1,r&&(a=2&s[0]?r.return:s[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,s[1])).done)return a;switch(r=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return c.label++,{value:s[1],done:!1};case 5:c.label++,r=s[1],s=[0];continue;case 7:s=c.ops.pop(),c.trys.pop();continue;default:if(!(a=c.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){c=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){c.label=s[1];break}if(6===s[0]&&c.label<a[1]){c.label=a[1],a=s;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(s);break}a[2]&&c.ops.pop(),c.trys.pop();continue}s=e.call(t,c)}catch(t){s=[6,t],r=0}finally{n=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}}"function"==typeof SuppressedError&&SuppressedError;var a,c="http://localhost:3001/v1";function o(e,a){return n(this,void 0,void 0,(function(){var n,o,s,i;return r(this,(function(r){switch(r.label){case 0:for(n=[],o=[],s=0;s<e.length;s+=10)o.push(e.slice(s,s+10));r.label=1;case 1:return r.trys.push([1,3,,4]),[4,Promise.all(o.map((function(e,n){return t.post("".concat(c,"/activity/bulk?workspaceId=").concat(a),e).catch((function(t){return console.error("Error processing batch ".concat(n+1,":"),t),{data:[]}}))})))];case 2:return i=r.sent(),n.push.apply(n,i.flatMap((function(t){return t.data}))),[3,4];case 3:return r.sent(),console.error("Fatal error processing batches"),[3,4];case 4:return[2,n]}}))}))}function s(e,a){return n(this,void 0,void 0,(function(){var n,o,s,i;return r(this,(function(r){switch(r.label){case 0:for(n=[],o=[],s=0;s<e.length;s+=10)o.push(e.slice(s,s+10));r.label=1;case 1:return r.trys.push([1,3,,4]),[4,Promise.all(o.map((function(e,n){return t.post("".concat(c,"/tasks/bulk?workspaceId=").concat(a),e).catch((function(t){return console.error("Error processing batch ".concat(n+1,":"),t),{data:[]}}))})))];case 2:return i=r.sent(),n.push.apply(n,i.flatMap((function(t){return t.data}))),[3,4];case 3:return r.sent(),console.error("Fatal error processing batches"),[3,4];case 4:return[2,n]}}))}))}function i(e,a){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,t.get(e,{headers:{Authorization:"Bearer ".concat(a),Accept:"application/vnd.github+json","X-GitHub-Api-Version":"2022-11-28"}})];case 1:return[2,n.sent().data]}}))}))}function u(e,a,o){return n(this,void 0,void 0,(function(){var n,s,u,l,p,d,h;return r(this,(function(r){switch(r.label){case 0:return n=o.oauthResponse,s=o.integrationDefinition,[4,i("https://api.github.com/user",(u={refresh_token:n.refresh_token,access_token:n.access_token}).access_token)];case 1:return l=r.sent(),[4,i("https://api.github.com/user/repos",u.access_token)];case 2:return p=r.sent(),d=p.map((function(t){return{id:t.id.toString(),name:t.name,private:t.private,fullName:t.full_name}})),h={settings:{login:l.login,scheduled:!0,schedule_frequency:"*/5 * * * *",repositories:d},userId:e,accountId:l.id.toString(),config:u,workspaceId:a,integrationDefinitionId:s.id},[4,t.post("".concat(c,"/integration_account"),h)];case 3:return[2,r.sent().data]}}))}))}function l(a){return n(this,void 0,void 0,(function(){var u,l,p,d,h,g,f,v,b,y=this;return r(this,(function(_){switch(_.label){case 0:if(u=a.integrationAccount,l=u.integrationConfiguration,!(null==(p=u.settings)?void 0:p.lastSyncTime))return[2,{message:"No last sync time in settings of integration account ".concat(u.id)}];d=p.lastSyncTime,h=["assign","review_requested","mention","state_change","subscribed","author"],g=1,f=!0,v=0,b=function(){var b,_,m,w;return r(this,(function(I){switch(I.label){case 0:return[4,i("https://api.github.com/notifications?page=".concat(g,"&per_page=50&all=true&since=").concat(d),l.access_token)];case 1:return 0===(b=I.sent()).length?(f=!1,[2,"break"]):(g++,_=b.filter((function(t){return h.includes(t.reason)})),v+=(null==_?void 0:_.length)||0,m=[],w=[],[4,Promise.all(_.map((function(t){return n(y,void 0,void 0,(function(){var e,n,c,o,s,p,d,h,g,f,v;return r(this,(function(r){switch(r.label){case 0:switch(e=t.reason,n=t.subject,c="",o="",s="",p=!1,d="",h="Todo",g="",f="",v={},e){case"mention":return[3,1];case"assign":return[3,3];case"review_requested":return[3,5];case"state_change":return[3,7];case"subscribed":return[3,9];case"author":return[3,11]}return[3,13];case 1:return c=n.latest_comment_url,f=n.type.toLowerCase(),o="github_".concat(f,"_comment_mention"),s="".concat(f," mention: ").concat(n.title),p=!1,[4,i(c,l.access_token)];case 2:return v=r.sent(),[3,14];case 3:return c=n.url,f=n.type.toLowerCase(),o="github_".concat(f,"_assigned"),s="".concat(f," Assign: ").concat(n.title),p=!0,[4,i(c,l.access_token)];case 4:return v=r.sent(),d=v.id.toString(),h="open"===v.state?"Todo":"Done",g="#".concat(v.number," - ").concat(v.title),[3,14];case 5:return c=n.url,f=n.type.toLowerCase(),o="github_".concat(f,"_review_requested"),s="".concat(f," Review Requested: ").concat(n.title),p=!0,[4,i(c,l.access_token)];case 6:case 12:return v=r.sent(),d=v.id.toString(),h=a.merged?"Todo":"Done",g="#".concat(v.number," - ").concat(v.title),[3,14];case 7:return c=n.url,f=n.type.toLowerCase(),o="github_".concat(f,"_state_change"),s="".concat(f," State Changed: ").concat(n.title),p=!0,[4,i(c,l.access_token)];case 8:case 10:return v=r.sent(),d=v.id.toString(),h="issue"===f?"open"===v.state?"Todo":"Done":a.merged?"Todo":"Done",g="#".concat(v.number," - ").concat(v.title),[3,14];case 9:case 11:return c=n.url,f=n.type.toLowerCase(),o="github_".concat(f),s="".concat(f,": ").concat(n.title),p=!0,[4,i(c,l.access_token)];case 13:return[3,14];case 14:return c&&(p&&m.push({url:c,title:g,status:h,sourceId:d,integrationAccountId:u.id}),w.push({type:o,eventData:t,name:s,integrationAccountId:u.id})),[2]}}))}))})))]);case 2:return I.sent(),w.length>0?[4,o(w,u.workspaceId)]:[3,4];case 3:I.sent(),I.label=4;case 4:return m.length>0?[4,s(m,u.workspaceId)]:[3,6];case 5:I.sent(),I.label=6;case 6:return[4,t.post("".concat(c,"/integration_account/").concat(u.id),{settings:e(e({},p),{lastSyncTime:(new Date).toISOString()})})];case 7:return I.sent(),[2]}}))},_.label=1;case 1:return f?[5,b()]:[3,3];case 2:return"break"===_.sent()?[3,3]:[3,1];case 3:return[2,{message:"Processed ".concat(v," notifications from github")}]}}))}))}function p(a){return n(this,void 0,void 0,(function(){var u,l,p,d,h,g,f=this;return r(this,(function(v){switch(v.label){case 0:return u=a.integrationAccount,l=u.integrationConfiguration,p=u.settings,d=["assignee:".concat(p.login,"+type:issue+is:open"),"review-requested:".concat(p.login,"+type:pr+is:open"),"author:".concat(p.login,"+type:pr+is:open")],h=[],g=[],[4,Promise.all(d.map((function(t){return n(f,void 0,void 0,(function(){var e,n,a,c;return r(this,(function(r){switch(r.label){case 0:e=1,n=!0,r.label=1;case 1:return n?[4,i("https://api.github.com/search/issues?page=".concat(e,"&per_page=50&q=").concat(t),l.access_token)]:[3,3];case 2:return a=r.sent(),0===(null===(c=a.items)||void 0===c?void 0:c.length)?(n=!1,[3,3]):(a.items.map((function(t){var e=t.url,n={type:t.node_id.includes("PR")?"issue":"pullrequest"}.type.toLowerCase(),r="github_".concat(n),a="".concat(n,": ").concat(t.title),c=t.id.toString(),o="open"===t.state?"Todo":"Done",s="#".concat(t.number," - ").concat(t.title);return h.push({url:e,title:s,status:o,sourceId:c,integrationAccountId:u.id}),g.push({type:r,eventData:{id:t.id,url:t.url,comment_url:t.comment_url,html_url:t.html_url,number:t.number,title:t.title,state:t.state},name:a,integrationAccountId:u.id}),!0})),e++,[3,1]);case 3:return[2]}}))}))})))];case 1:return v.sent(),g.length>0?[4,o(g,u.workspaceId)]:[3,3];case 2:v.sent(),v.label=3;case 3:return h.length>0?[4,s(h,u.workspaceId)]:[3,5];case 4:v.sent(),v.label=5;case 5:return[4,t.post("".concat(c,"/integration_account/").concat(u.id),{settings:e(e({},p),{lastSyncTime:(new Date).toISOString()})})];case 6:return v.sent(),[2]}}))}))}exports.IntegrationPayloadEventType=void 0,(a=exports.IntegrationPayloadEventType||(exports.IntegrationPayloadEventType={})).GET_CONNECTED_ACCOUNT_ID="get_connected_account_id",a.CREATE="create",a.DELETE="delete",a.GET_TOKEN="get_token",a.SCHEDULED_TASK="scheduled_task",a.SYNC_INITIAL_TASK="sync_initial_task",exports.run=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:switch(t.event){case exports.IntegrationPayloadEventType.CREATE:return[3,1];case exports.IntegrationPayloadEventType.SCHEDULED_TASK:return[3,3];case exports.IntegrationPayloadEventType.GET_TOKEN:return[3,4];case exports.IntegrationPayloadEventType.SYNC_INITIAL_TASK:return[3,5]}return[3,6];case 1:return[4,u(t.userId,t.workspaceId,t.eventBody)];case 2:return[2,e.sent()];case 3:return[2,l(t.eventBody)];case 4:return[2,t.eventBody.integrationAccount.integrationConfiguration.access_token];case 5:return[2,p(t.eventBody)];case 6:return[2,{message:"The event payload type is ".concat(t.event)}]}}))}))};
//# sourceMappingURL=index.js.map
