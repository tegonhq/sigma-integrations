"use strict";var t=require("axios"),e=function(){return e=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var c in e=arguments[n])Object.prototype.hasOwnProperty.call(e,c)&&(t[c]=e[c]);return t},e.apply(this,arguments)};function n(t,e,n,r){return new(n||(n=Promise))((function(c,o){function a(t){try{i(r.next(t))}catch(t){o(t)}}function s(t){try{i(r.throw(t))}catch(t){o(t)}}function i(t){var e;t.done?c(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}i((r=r.apply(t,e||[])).next())}))}function r(t,e){var n,r,c,o={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(i){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(o=0)),o;)try{if(n=1,r&&(c=2&s[0]?r.return:s[0]?r.throw||((c=r.return)&&c.call(r),0):r.next)&&!(c=c.call(r,s[1])).done)return c;switch(r=0,c&&(s=[2&s[0],c.value]),s[0]){case 0:case 1:c=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(c=o.trys,(c=c.length>0&&c[c.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!c||s[1]>c[0]&&s[1]<c[3])){o.label=s[1];break}if(6===s[0]&&o.label<c[1]){o.label=c[1],c=s;break}if(c&&o.label<c[2]){o.label=c[2],o.ops.push(s);break}c[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=c=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}}"function"==typeof SuppressedError&&SuppressedError;var c,o="http://localhost:3001/v1";function a(e,c){return n(this,void 0,void 0,(function(){var n,a,s,i;return r(this,(function(r){switch(r.label){case 0:for(n=[],a=[],s=0;s<e.length;s+=10)a.push(e.slice(s,s+10));r.label=1;case 1:return r.trys.push([1,3,,4]),[4,Promise.all(a.map((function(e,n){return t.post("".concat(o,"/activity/bulk?workspaceId=").concat(c),e).catch((function(t){return console.error("Error processing batch ".concat(n+1,":"),t),{data:[]}}))})))];case 2:return i=r.sent(),n.push.apply(n,i.flatMap((function(t){return t.data}))),[3,4];case 3:return r.sent(),console.error("Fatal error processing batches"),[3,4];case 4:return[2,n]}}))}))}function s(e,c){return n(this,void 0,void 0,(function(){var n,a,s,i;return r(this,(function(r){switch(r.label){case 0:for(n=[],a=[],s=0;s<e.length;s+=10)a.push(e.slice(s,s+10));r.label=1;case 1:return r.trys.push([1,3,,4]),[4,Promise.all(a.map((function(e,n){return t.post("".concat(o,"/tasks/bulk?workspaceId=").concat(c),e).catch((function(t){return console.error("Error processing batch ".concat(n+1,":"),t),{data:[]}}))})))];case 2:return i=r.sent(),n.push.apply(n,i.flatMap((function(t){return t.data}))),[3,4];case 3:return r.sent(),console.error("Fatal error processing batches"),[3,4];case 4:return[2,n]}}))}))}function i(e,c){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,t.get(e,{headers:{Authorization:"Bearer ".concat(c),Accept:"application/vnd.github+json","X-GitHub-Api-Version":"2022-11-28"}})];case 1:return[2,n.sent().data]}}))}))}function u(e,c,a){return n(this,void 0,void 0,(function(){var n,s,u,l,p;return r(this,(function(r){switch(r.label){case 0:return n=a.oauthResponse,s=a.integrationDefinition,[4,i("https://api.github.com/user",(u={refresh_token:n.refresh_token,access_token:n.access_token}).access_token)];case 1:return l=r.sent(),p={settings:{login:l.login,scheduled:!0,schedule_frequency:"*/5 * * * *"},userId:e,accountId:l.id.toString(),config:u,workspaceId:c,integrationDefinitionId:s.id},[4,t.post("".concat(o,"/integration_account"),p)];case 2:return[2,r.sent().data]}}))}))}function l(c){return n(this,void 0,void 0,(function(){var u,l,p,d,h,g,f,b,v,_=this;return r(this,(function(y){switch(y.label){case 0:if(u=c.integrationAccount,l=u.integrationConfiguration,!(null==(p=u.settings)?void 0:p.lastSyncTime))return[2,{message:"No last sync time in settings of integration account ".concat(u.id)}];d=p.lastSyncTime,h=["assign","review_requested","mention","state_change","subscribed","author"],g=1,f=!0,b=0,v=function(){var v,y,m,w;return r(this,(function(I){switch(I.label){case 0:return[4,i("https://api.github.com/notifications?page=".concat(g,"&per_page=50&all=true&since=").concat(d),l.access_token)];case 1:return 0===(v=I.sent()).length?(f=!1,[2,"break"]):(g++,y=v.filter((function(t){return h.includes(t.reason)})),b+=(null==y?void 0:y.length)||0,m=[],w=[],[4,Promise.all(y.map((function(t){return n(_,void 0,void 0,(function(){var e,n,o,a,s,p,d,h,g,f,b;return r(this,(function(r){switch(r.label){case 0:switch(e=t.reason,n=t.subject,o="",a="",s="",p=!1,d="",h="Todo",g="",f="",b={},e){case"mention":return[3,1];case"assign":return[3,3];case"review_requested":return[3,5];case"state_change":return[3,7];case"subscribed":return[3,9];case"author":return[3,11]}return[3,13];case 1:return o=n.latest_comment_url,f=n.type.toLowerCase(),a="github_".concat(f,"_comment_mention"),s="".concat(f," mention: ").concat(n.title),p=!1,[4,i(o,l.access_token)];case 2:return b=r.sent(),[3,14];case 3:return o=n.url,f=n.type.toLowerCase(),a="github_".concat(f,"_assigned"),s="".concat(f," Assign: ").concat(n.title),p=!0,[4,i(o,l.access_token)];case 4:return b=r.sent(),d=b.id.toString(),h="open"===b.state?"Todo":"Done",g="#".concat(b.number," - ").concat(b.title),[3,14];case 5:return o=n.url,f=n.type.toLowerCase(),a="github_".concat(f,"_review_requested"),s="".concat(f," Review Requested: ").concat(n.title),p=!0,[4,i(o,l.access_token)];case 6:case 12:return b=r.sent(),d=b.id.toString(),h=c.merged?"Todo":"Done",g="#".concat(b.number," - ").concat(b.title),[3,14];case 7:return o=n.url,f=n.type.toLowerCase(),a="github_".concat(f,"_state_change"),s="".concat(f," State Changed: ").concat(n.title),p=!0,[4,i(o,l.access_token)];case 8:case 10:return b=r.sent(),d=b.id.toString(),h="issue"===f?"open"===b.state?"Todo":"Done":c.merged?"Todo":"Done",g="#".concat(b.number," - ").concat(b.title),[3,14];case 9:case 11:return o=n.url,f=n.type.toLowerCase(),a="github_".concat(f),s="".concat(f,": ").concat(n.title),p=!0,[4,i(o,l.access_token)];case 13:return[3,14];case 14:return o&&(p&&m.push({url:o,title:g,status:h,sourceId:d,integrationAccountId:u.id}),w.push({type:a,eventData:t,name:s,integrationAccountId:u.id})),[2]}}))}))})))]);case 2:return I.sent(),w.length>0?[4,a(w,u.workspaceId)]:[3,4];case 3:I.sent(),I.label=4;case 4:return m.length>0?[4,s(m,u.workspaceId)]:[3,6];case 5:I.sent(),I.label=6;case 6:return[4,t.post("".concat(o,"/integration_account/").concat(u.id),{settings:e(e({},p),{lastSyncTime:(new Date).toISOString()})})];case 7:return I.sent(),[2]}}))},y.label=1;case 1:return f?[5,v()]:[3,3];case 2:return"break"===y.sent()?[3,3]:[3,1];case 3:return[2,{message:"Processed ".concat(b," notifications from github")}]}}))}))}function p(c){return n(this,void 0,void 0,(function(){var u,l,p,d,h,g,f=this;return r(this,(function(b){switch(b.label){case 0:return u=c.integrationAccount,l=u.integrationConfiguration,p=u.settings,d=["assignee:".concat(p.login,"+type:issue+is:open"),"review-requested:".concat(p.login,"+type:pr+is:open"),"author:".concat(p.login,"+type:pr+is:open")],h=[],g=[],[4,Promise.all(d.map((function(t){return n(f,void 0,void 0,(function(){var e,n,c,o;return r(this,(function(r){switch(r.label){case 0:e=1,n=!0,r.label=1;case 1:return n?[4,i("https://api.github.com/search/issues?page=".concat(e,"&per_page=50&q=").concat(t),l.access_token)]:[3,3];case 2:return c=r.sent(),0===(null===(o=c.items)||void 0===o?void 0:o.length)?(n=!1,[3,3]):(c.items.map((function(t){var e=t.url,n={type:t.node_id.includes("PR")?"issue":"pullrequest"}.type.toLowerCase(),r="github_".concat(n),c="".concat(n,": ").concat(t.title),o=t.id.toString(),a="open"===t.state?"Todo":"Done",s="#".concat(t.number," - ").concat(t.title);return h.push({url:e,title:s,status:a,sourceId:o,integrationAccountId:u.id}),g.push({type:r,eventData:{id:t.id,url:t.url,comment_url:t.comment_url,html_url:t.html_url,number:t.number,title:t.title,state:t.state},name:c,integrationAccountId:u.id}),!0})),e++,[3,1]);case 3:return[2]}}))}))})))];case 1:return b.sent(),g.length>0?[4,a(g,u.workspaceId)]:[3,3];case 2:b.sent(),b.label=3;case 3:return h.length>0?[4,s(h,u.workspaceId)]:[3,5];case 4:b.sent(),b.label=5;case 5:return[4,t.post("".concat(o,"/integration_account/").concat(u.id),{settings:e(e({},p),{lastSyncTime:(new Date).toISOString()})})];case 6:return b.sent(),[2]}}))}))}exports.IntegrationPayloadEventType=void 0,(c=exports.IntegrationPayloadEventType||(exports.IntegrationPayloadEventType={})).GET_CONNECTED_ACCOUNT_ID="get_connected_account_id",c.SPEC="spec",c.CREATE="create",c.DELETE="delete",c.SOURCE_WEBHOOK="source_webhook",c.GET_TOKEN="get_token",c.WEBHOOK_RESPONSE="webhook_response",c.SCHEDULED_TASK="scheduled_task",c.SYNC_INITIAL_TASK="sync_initial_task",exports.run=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:switch(t.event){case exports.IntegrationPayloadEventType.CREATE:return[3,1];case exports.IntegrationPayloadEventType.SCHEDULED_TASK:return[3,3];case exports.IntegrationPayloadEventType.SYNC_INITIAL_TASK:return[3,4]}return[3,5];case 1:return[4,u(t.userId,t.workspaceId,t.eventBody)];case 2:return[2,e.sent()];case 3:return[2,l(t.eventBody)];case 4:return[2,p(t.eventBody)];case 5:return[2,{message:"The event payload type is ".concat(t.event)}]}}))}))};
//# sourceMappingURL=index.js.map
